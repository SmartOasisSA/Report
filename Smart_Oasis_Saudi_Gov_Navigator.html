<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Oasis | 沙特政府关系战略系统</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts (Noto Sans SC) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Tailwind Config for Custom Palette -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Noto Sans SC"', 'sans-serif'],
                    },
                    colors: {
                        'sand-50': '#f9f7f2',
                        'sand-100': '#f0eadd',
                        'sand-200': '#e2d6c0',
                        'saudi-green': '#1e5f44',
                        'saudi-green-light': '#2d8a63',
                        'gold-accent': '#c5a065',
                        'slate-dark': '#334155',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-in-right': 'slideInRight 0.3s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        slideInRight: {
                            '0%': { transform: 'translateX(100%)' },
                            '100%': { transform: 'translateX(0)' },
                        }
                    },
                    boxShadow: {
                        'card': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'floating': '0 10px 40px -10px rgba(30, 95, 68, 0.15)',
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f0eadd; 
        }
        ::-webkit-scrollbar-thumb {
            background: #c5a065; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #1e5f44; 
        }

        /* Transitions */
        .transition-all-300 {
            transition: all 0.3s ease-in-out;
        }

        /* Ecosystem Tree Styles */
        .eco-node {
            position: relative;
            z-index: 10;
            transition: all 0.3s ease;
        }
        .eco-node:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .connector-v {
            width: 2px;
            background-color: #e2d6c0; /* sand-200 */
            margin: 0 auto;
            position: relative;
        }
        
        /* Accordion Animation */
        details > summary {
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        details[open] summary ~ * {
            animation: sweep .3s ease-in-out;
        }
        @keyframes sweep {
            0%    {opacity: 0; transform: translateY(-10px)}
            100%  {opacity: 1; transform: translateY(0)}
        }

        /* AI Chat Bubble Styles */
        .chat-bubble {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            font-size: 0.95rem;
            line-height: 1.6;
            position: relative;
            word-wrap: break-word;
        }
        .chat-bubble.user {
            background-color: #1e5f44;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }
        .chat-bubble.ai {
            background-color: #ffffff;
            color: #334155;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
            border: 1px solid #e2d6c0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .typing-dot {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #888;
            animation: typing 1.4s infinite ease-in-out both;
            margin: 0 2px;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body class="bg-sand-50 text-slate-dark font-sans antialiased overflow-hidden h-screen flex flex-col lg:flex-row">

    <!-- Mobile Nav Toggle -->
    <div class="lg:hidden bg-saudi-green text-white p-4 flex justify-between items-center shadow-md fixed w-full z-50 top-0 h-16">
        <div class="flex items-center gap-2">
            <div class="h-6 w-6 bg-white/10 rounded flex items-center justify-center text-xs font-bold text-gold-accent border border-gold-accent/30">S</div>
            <h1 class="text-lg font-bold">Smart Oasis</h1>
        </div>
        <button id="menu-btn" class="text-white focus:outline-none text-2xl">☰</button>
    </div>

    <!-- Sidebar Navigation -->
    <aside id="sidebar" class="bg-saudi-green text-white w-64 space-y-6 py-4 px-2 absolute inset-y-0 left-0 transform -translate-x-full lg:relative lg:translate-x-0 transition duration-300 ease-in-out z-40 h-full flex flex-col pt-20 lg:pt-6 shadow-2xl lg:shadow-none border-r border-saudi-green-light/30">
        <div class="px-4 mb-6 hidden lg:block">
            <div class="flex items-center gap-3 mb-2">
                <div class="h-10 w-10 bg-white/10 rounded-lg text-gold-accent flex items-center justify-center font-bold text-xl shadow-lg border border-gold-accent/40 backdrop-blur-sm">S</div>
                <div>
                    <h2 class="text-xl font-bold tracking-wide leading-none">Smart Oasis</h2>
                    <p class="text-[10px] text-sand-200 mt-1 uppercase tracking-wider opacity-80">Knowledge Base</p>
                </div>
            </div>
        </div>

        <nav class="flex-1 space-y-1 overflow-y-auto px-2">
            <a href="#" onclick="showSection('dashboard')" class="nav-item block py-3 px-4 rounded-lg transition duration-200 hover:bg-white/10 hover:text-white bg-white/10 font-bold flex items-center gap-3 mb-1" data-target="dashboard">
                <svg class="w-5 h-5 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                生态全景图
            </a>
            <a href="#" onclick="showSection('workflow')" class="nav-item block py-3 px-4 rounded-lg transition duration-200 hover:bg-white/10 hover:text-white flex items-center gap-3 mb-1" data-target="workflow">
                <svg class="w-5 h-5 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                业务流程
            </a>
            <a href="#" onclick="showSection('directory')" class="nav-item block py-3 px-4 rounded-lg transition duration-200 hover:bg-white/10 hover:text-white flex items-center gap-3 mb-1" data-target="directory">
                <svg class="w-5 h-5 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                机构百科全书
            </a>
            <a href="#" onclick="showSection('legal')" class="nav-item block py-3 px-4 rounded-lg transition duration-200 hover:bg-white/10 hover:text-white flex items-center gap-3 mb-1" data-target="legal">
                <svg class="w-5 h-5 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"></path></svg>
                法律法规库
            </a>
        </nav>

        <!-- AI Button in Sidebar -->
        <div class="px-4 pb-6 mt-auto">
            <button onclick="toggleAIChat()" class="w-full py-3 px-4 bg-gradient-to-r from-gold-accent to-yellow-700 text-white rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all flex items-center justify-center space-x-2 font-bold group border border-white/10">
                <span class="text-xl group-hover:animate-pulse">✨</span>
                <span>智能知识助手</span>
            </button>
        </div>

        <div class="p-4 text-[10px] text-sand-200/60 border-t border-white/10">
            <p>Version 2.0 | Dec 2025</p>
            <p class="font-mono mt-1">INTERNAL USE ONLY</p>
        </div>
    </aside>

    <!-- Overlay for mobile sidebar -->
    <div id="sidebar-overlay" onclick="document.getElementById('sidebar').classList.add('-translate-x-full'); document.getElementById('sidebar-overlay').classList.add('hidden');" class="fixed inset-0 bg-black/50 z-30 hidden lg:hidden backdrop-blur-sm"></div>

    <!-- Main Content -->
    <main class="flex-1 w-full lg:ml-0 transition-all-300 h-full flex flex-col relative bg-sand-50">
        <div class="flex-1 overflow-y-auto p-4 lg:p-10 scroll-smooth">
            <div class="max-w-7xl mx-auto space-y-8 pb-12 pt-16 lg:pt-0">
                
                <!-- VIEW 1: ECOSYSTEM PANORAMA -->
                <div id="dashboard" class="section-content block animate-fade-in">
                    <!-- Header -->
                    <header class="mb-8 border-b-2 border-gold-accent pb-6">
                        <div class="flex flex-col md:flex-row md:justify-between md:items-end gap-4">
                            <div>
                                <h1 class="text-3xl lg:text-4xl font-bold text-saudi-green tracking-tight">沙特房地产权力生态全景</h1>
                                <p class="mt-2 text-slate-600">
                                    理清沙特政府机构的隶属、监管与执行关系，识别“裁判员”与“运动员”。
                                </p>
                            </div>
                            <div class="text-right hidden md:block">
                                <span class="bg-saudi-green/10 text-saudi-green px-3 py-1 rounded-full text-xs font-bold">Updated: 2025.12</span>
                            </div>
                        </div>
                    </header>

                    <!-- Admin System Comparison (Expandable) -->
                    <div class="bg-white rounded-xl border border-sand-200 shadow-card overflow-hidden mb-10 group hover:shadow-md transition-shadow">
                        <!-- Added 'open' attribute here -->
                        <details class="group" open>
                            <summary class="flex justify-between items-center font-medium cursor-pointer list-none p-5 bg-gradient-to-r from-sand-50 to-white hover:bg-sand-100 transition-colors">
                                <span class="text-saudi-green font-bold flex items-center gap-3 text-lg">
                                    <div class="p-1.5 bg-saudi-green/10 rounded-full">
                                        <svg class="w-5 h-5 text-saudi-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    </div>
                                    沙特行政体系 vs 中国体系 (差异对比)
                                </span>
                                <span class="transition-transform duration-300 group-open:rotate-180 text-saudi-green bg-white rounded-full p-1 shadow-sm">
                                    <svg fill="none" height="20" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="20"><path d="M6 9l6 6 6-6"></path></svg>
                                </span>
                            </summary>
                            <div class="text-gray-600 text-sm p-6 border-t border-sand-200 leading-relaxed bg-white">
                                <div class="w-full">
                                    <h4 class="font-bold text-slate-800 mb-4 text-base border-l-4 border-gold-accent pl-3">核心逻辑差异</h4>
                                    <p class="mb-4 text-slate-600">沙特行政体系没有中国严格的“省厅-市局-县局”垂直管理体系，而是呈现<strong>“中央部委决策 + 强力总局监管 + 地区市政署执行”</strong>的扁平化格局。</p>
                                    <ul class="space-y-4 text-slate-600">
                                        <li class="flex items-start gap-4">
                                            <span class="font-bold text-saudi-green min-w-[260px] shrink-0">决策层（Ministry / 部）:</span>
                                            <span>类似中国的中央部委（如住建部）。主要负责制定国家战略、宏观政策和法律框架，通常不直接处理具体企业的琐事。</span>
                                        </li>
                                        <li class="flex items-start gap-4">
                                            <span class="font-bold text-gold-accent min-w-[260px] shrink-0">监管层（Authority / 总局）:</span>
                                            <span>我们需要重点关注的层级。它们往往拥有极高的独立性和执法权，专门负责某个垂直领域的发牌、监管和处罚（如房地产总局REGA），类似于中国的“银保监会”或“证监会”在特定行业的角色。</span>
                                        </li>
                                        <li class="flex items-start gap-4">
                                            <span class="font-bold text-slate-500 min-w-[260px] shrink-0">执行层（Amanah / 市政署）:</span>
                                            <span>沙特没有“省房管局”，地方上的具体执行（如发施工证、修路、收垃圾）全部由各城市的 Amanah 负责。</span>
                                        </li>
                                        <li class="flex items-start gap-4">
                                            <span class="font-bold text-slate-500 min-w-[260px] shrink-0">G.R.E.s (国家队):</span>
                                            <span>类似中国的央企（如中建、中铁），但在沙特，它们承担了部分“政府职能”，如国家住房公司（NHC），既是我们的竞争对手，也可能是最大的合作伙伴。</span>
                                        </li>                                
                                    </ul>
                                </div>
                            </div>
                        </details>
                    </div>

                    <!-- Vertical Ecosystem Tree -->
                    <div class="bg-white rounded-xl p-8 lg:p-12 border border-sand-200 shadow-card flex justify-center overflow-x-auto relative min-h-[600px]">
                        <!-- Background Grid Pattern -->
                        <div class="absolute inset-0 opacity-[0.03]" style="background-image: radial-gradient(#1e5f44 1px, transparent 1px); background-size: 20px 20px;"></div>

                        <div class="w-full max-w-5xl flex flex-col items-center gap-8 min-w-[700px] relative z-10">
                            
                            <!-- Level 1: King -->
                            <div class="eco-node bg-saudi-green text-white px-10 py-4 rounded-lg shadow-floating text-center min-w-[240px] border-b-4 border-gold-accent">
                                <div class="font-bold text-xl tracking-wide">国王 / 内阁</div>
                                <div class="text-[10px] opacity-80 uppercase tracking-widest mt-1">Council of Ministers</div>
                            </div>

                            <!-- Connector -->
                            <div class="h-10 connector-v"></div>

                            <!-- Level 2: Top Strategies (Split) -->
                            <div class="grid grid-cols-2 gap-16 w-full relative">
                                <!-- Horizontal Connector for Level 2 -->
                                <div class="absolute top-0 left-1/4 right-1/4 h-0.5 bg-sand-200 -mt-10 hidden md:block rounded-full"></div> 
                                <div class="absolute top-0 left-1/4 h-10 w-0.5 bg-sand-200 -mt-10 hidden md:block"></div>
                                <div class="absolute top-0 right-1/4 h-10 w-0.5 bg-sand-200 -mt-10 hidden md:block"></div>

                                <!-- Left: MOMAH System (Complex) -->
                                <div class="flex flex-col items-center">
                                    <div class="eco-node bg-sand-50 border-2 border-saudi-green-light/20 p-5 rounded-lg shadow-sm text-center w-full max-w-[320px]">
                                        <div class="font-bold text-saudi-green text-lg">MOMAH 市政与住房部</div>
                                        <div class="text-xs text-saudi-green-light mt-1 font-bold bg-white/50 inline-block px-2 py-0.5 rounded">房地产最高主管部门</div>
                                    </div>
                                    
                                    <div class="h-8 connector-v"></div>

                                    <!-- MOMAH Sub-entities Grid -->
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full relative">
                                        <!-- Horizontal Line for MOMAH children -->
                                        <div class="absolute top-0 left-6 right-6 h-0.5 bg-sand-200 -mt-8 hidden md:block"></div>
                                        <div class="absolute top-0 left-1/2 h-8 w-0.5 bg-sand-200 -mt-8 hidden md:block"></div>
                                        <div class="absolute top-0 left-6 h-8 w-0.5 bg-sand-200 -mt-8 hidden md:block"></div>
                                        <div class="absolute top-0 right-6 h-8 w-0.5 bg-sand-200 -mt-8 hidden md:block"></div>

                                        <!-- REGA (Regulator) -->
                                        <div class="flex flex-col items-center">
                                            <div class="eco-node bg-white border-t-4 border-gold-accent p-3 rounded shadow-sm text-center w-full border border-sand-100">
                                                <div class="font-bold text-slate-800">REGA 房产总局</div>
                                                <div class="text-[10px] text-white bg-gold-accent px-2 py-0.5 rounded-full inline-block mt-1 font-bold">行业监管</div>
                                            </div>
                                            <div class="h-4 connector-v"></div>
                                            <div class="bg-sand-50 border border-sand-200 rounded p-3 w-full space-y-2 shadow-inner">
                                                <div class="text-[10px] text-center font-bold text-gray-400 uppercase">下属平台</div>
                                                <div class="grid gap-1.5">
                                                    <div class="bg-white border border-sand-100 rounded px-2 py-1.5 text-xs text-center text-slate-600 font-medium hover:text-saudi-green hover:border-saudi-green cursor-default transition-colors">Ejar (租赁)</div>
                                                    <div class="bg-white border border-sand-100 rounded px-2 py-1.5 text-xs text-center text-slate-600 font-medium hover:text-saudi-green hover:border-saudi-green cursor-default transition-colors">Wafi (期房)</div>
                                                    <div class="bg-white border border-sand-100 rounded px-2 py-1.5 text-xs text-center text-slate-600 font-medium hover:text-saudi-green hover:border-saudi-green cursor-default transition-colors">Mullak (物业)</div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- NHC (Partner) -->
                                        <div class="flex flex-col items-center">
                                            <div class="eco-node bg-white border-2 border-green-600 border-dashed p-4 rounded shadow-sm text-center w-full border border-sand-100 h-full flex flex-col justify-center">
                                                <div class="font-bold text-slate-800">NHC 国家住房公司</div>
                                                <div class="text-xs text-green-600 font-bold mt-1">最大地主 / 国企</div>
                                            </div>
                                        </div>

                                        <!-- Etmam (Service) -->
                                        <div class="flex flex-col items-center">
                                            <div class="eco-node bg-white border-t-4 border-saudi-green-light p-3 rounded shadow-sm text-center w-full border border-sand-100">
                                                <div class="font-bold text-slate-800">Etmam 服务中心</div>
                                                <div class="text-[10px] text-white bg-saudi-green-light px-2 py-0.5 rounded-full inline-block mt-1 font-bold">绿色通道</div>
                                            </div>
                                            <div class="h-4 connector-v"></div>
                                            <div class="bg-white border border-sand-200 rounded p-2 text-xs text-center w-full text-slate-600 font-bold shadow-sm">
                                                Balady <br><span class="text-[10px] font-normal text-gray-400">技术平台</span>
                                            </div>
                                        </div>

                                    </div>
                                </div>

                                <!-- Right: RCRC System (Aligned Grid) -->
                                <div class="flex flex-col items-center">
                                    <div class="eco-node bg-white border-t-4 border-saudi-green p-5 rounded-lg shadow-sm text-center w-full max-w-[280px] border border-sand-100 hover:border-saudi-green/30">
                                        <div class="font-bold text-slate-800 text-lg">RCRC 利雅得皇家委员会</div>
                                        <div class="text-xs text-gray-400 mt-1 font-medium bg-gray-50 inline-block px-2 py-0.5 rounded">利雅得顶层战略设计</div>
                                    </div>
                                    <div class="h-8 connector-v"></div>
                                    <div class="eco-node bg-white border-l-4 border-slate-500 p-4 rounded shadow-sm text-center w-full max-w-[220px] border border-sand-100">
                                        <div class="font-bold text-slate-800">Riyadh Amanah</div>
                                        <div class="text-xs text-slate-500 font-bold uppercase tracking-wider mb-1">市政署 (执行)</div>
                                        <div class="text-[10px] text-gray-400 border-t border-gray-100 pt-1">发证 / 验收 / 执法</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- External Supports -->
                            <div class="w-full border-t-2 border-dashed border-sand-200 pt-8 mt-6">
                                <div class="text-center text-xs text-gray-400 mb-4 font-bold uppercase tracking-widest bg-white inline-block px-4 -mt-11 mx-auto relative z-20">关键外部协作机构</div>
                                <div class="flex flex-wrap justify-center gap-4">
                                    <div class="px-4 py-2 bg-white border border-sand-200 rounded shadow-sm text-xs font-bold text-slate-600 hover:border-gold-accent hover:text-gold-accent transition cursor-default">MISA 投资部</div>
                                    <div class="px-4 py-2 bg-white border border-sand-200 rounded shadow-sm text-xs font-bold text-slate-600 hover:border-gold-accent hover:text-gold-accent transition cursor-default">MC 商务部</div>
                                    <div class="px-4 py-2 bg-white border border-sand-200 rounded shadow-sm text-xs font-bold text-slate-600 hover:border-gold-accent hover:text-gold-accent transition cursor-default">ZATCA 税务局</div>
                                    <div class="px-4 py-2 bg-white border border-sand-200 rounded shadow-sm text-xs font-bold text-slate-600 hover:border-gold-accent hover:text-gold-accent transition cursor-default">Civil Defense 民防</div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- VIEW 2: WORKFLOW -->
                <div id="workflow" class="section-content hidden animate-fade-in">
                    <header class="mb-8 border-b-2 border-gold-accent pb-4">
                        <h1 class="text-3xl lg:text-4xl font-bold text-saudi-green">业务全流程交互指引</h1>
                        <p class="mt-4 text-base md:text-lg text-slate-600 leading-relaxed">
                            从公司设立到产生收入的主要合规节点，每一步都关乎项目成败。
                        </p>
                    </header>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                        <!-- Step List -->
                        <div class="lg:col-span-4 space-y-3" id="workflow-steps-container">
                            <!-- JS Injected -->
                        </div>
                        <!-- Detail View -->
                        <div class="lg:col-span-8 bg-white border border-sand-200 rounded-xl p-8 shadow-card relative overflow-hidden flex flex-col justify-center min-h-[400px]" id="workflow-content">
                            <!-- JS Injected -->
                        </div>
                    </div>
                </div>

                <!-- VIEW 3: DIRECTORY (Expanded to all 16) -->
                <div id="directory" class="section-content hidden animate-fade-in">
                    <header class="mb-8 border-b-2 border-gold-accent pb-6 flex flex-col md:flex-row justify-between items-end gap-4">
                        <div>
                            <h1 class="text-3xl lg:text-4xl font-bold text-saudi-green">机构百科全书</h1>
                            <p class="mt-2 text-base text-slate-600 leading-relaxed">
                                收录 17 个核心相关的部委、总局、平台与国企。
                            </p>
                        </div>
                        <div class="relative w-full md:w-72">
                            <input type="text" id="searchInput" placeholder="搜索机构名称或缩写..." class="pl-10 pr-4 py-2.5 border border-sand-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-saudi-green w-full text-sm bg-white shadow-sm">
                            <svg class="w-4 h-4 text-gray-400 absolute left-3 top-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        </div>
                    </header>

                    <!-- Type Filters -->
                    <div class="flex flex-wrap gap-2 mb-8" id="filter-container"></div>

                    <!-- Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5" id="directory-grid">
                        <!-- Cards JS Injected -->
                    </div>
                </div>

                <!-- VIEW 4: LEGAL LIBRARY (Refined) -->
                <div id="legal" class="section-content hidden animate-fade-in">
                    <header class="mb-8 border-b-2 border-gold-accent pb-4">
                        <h1 class="text-3xl lg:text-4xl font-bold text-saudi-green">房地产法律法规库</h1>
                        <p class="mt-4 text-base md:text-lg text-slate-600 leading-relaxed">
                            与 Smart Oasis 业务紧密相关的现行法律框架与合规要点。
                        </p>
                    </header>
                    
                    <div class="space-y-4 max-w-4xl" id="legal-list">
                        <!-- JS Injected -->
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- AI Chat Widget -->
    <div id="ai-chat-panel" class="fixed top-0 right-0 h-full w-full md:w-[400px] bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-50 flex flex-col border-l border-sand-200">
        <!-- Header -->
        <div class="bg-saudi-green p-4 flex justify-between items-center text-white shadow-md">
            <div class="flex items-center space-x-3">
                <div class="bg-white/10 p-1.5 rounded-lg">
                    <span class="text-xl">✨</span>
                </div>
                <div>
                    <h3 class="font-bold text-lg">智能知识助手</h3>
                    <p class="text-[10px] text-saudi-green-light opacity-90 uppercase tracking-wider">Powered by Gemini 2.5</p>
                </div>
            </div>
            <button onclick="toggleAIChat()" class="hover:bg-white/10 p-2 rounded-lg transition text-white/80 hover:text-white">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        
        <!-- Chat Area -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 bg-sand-50/50 flex flex-col space-y-4">
            <div class="chat-bubble ai animate-fade-in">
                你好！我是您的 Smart Oasis 内部知识助手。
                <br><br>
                您可以问我关于<strong>机构职能（如REGA, MOMAH）、办事流程、或法律法规</strong>的问题。
            </div>
            
            <!-- Suggested Questions -->
            <div class="flex flex-wrap gap-2 mt-2 px-1">
                <button onclick="askQuestion('REGA和MOMAH有什么区别？')" class="text-xs bg-white border border-sand-200 px-3 py-1.5 rounded-full hover:border-saudi-green hover:text-saudi-green transition shadow-sm">🏛️ REGA vs MOMAH</button>
                <button onclick="askQuestion('拿地开发的流程是什么？')" class="text-xs bg-white border border-sand-200 px-3 py-1.5 rounded-full hover:border-saudi-green hover:text-saudi-green transition shadow-sm">🏗️ 开发流程</button>
                <button onclick="askQuestion('外国投资者如何进入沙特市场？')" class="text-xs bg-white border border-sand-200 px-3 py-1.5 rounded-full hover:border-saudi-green hover:text-saudi-green transition shadow-sm">🌏 市场准入</button>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-4 bg-white border-t border-gray-200">
            <div class="relative">
                <input type="text" id="user-input" class="w-full border border-gray-300 rounded-xl pl-4 pr-12 py-3 focus:outline-none focus:border-saudi-green focus:ring-1 focus:ring-saudi-green transition shadow-inner bg-gray-50 focus:bg-white" placeholder="输入问题..." onkeypress="handleKeyPress(event)">
                <button onclick="sendMessage()" class="absolute right-2 top-2 bg-saudi-green text-white p-1.5 rounded-lg hover:bg-saudi-green-light transition shadow-sm">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path></svg>
                </button>
            </div>
            <div class="text-[10px] text-gray-400 text-center mt-2">
                AI生成内容可能包含错误，请以官方文件为准。
            </div>
        </div>
    </div>
    
    <!-- Overlay -->
    <div id="chat-overlay" onclick="toggleAIChat()" class="fixed inset-0 bg-black/30 z-40 hidden transition-opacity duration-300 backdrop-blur-sm"></div>

    <!-- JS Logic -->
    <script>
        // --- DATASET ---
        const agencyData = [
            { 
                id: 'momah', 
                name: '市政与住房部', 
                abbr: 'MOMAH', 
                type: 'ministry', 
                role: '核心主管 / 超级部委', 
                desc: '房地产最高主管部门，由原市政部与住房部合并而成。内阁核心部委，体量庞大。', 
                details: '<strong>官网：</strong><a href="https://www.momrah.gov.sa" target="_blank" class="text-saudi-green hover:underline">www.momrah.gov.sa</a><br><br><strong>生态位：</strong>既管宏观政策（住房供给），又管微观市政（街道卫生）。<br><strong>关键职能：</strong><br>1. <strong>城市规划代理部</strong>：审批大区域规划与Zoning变更。<br>2. <strong>开发商服务中心 (Etmam)</strong>：开发商的绿色通道，加速跨部门审批。<br>3. <strong>Balady平台</strong>：数字化门户，申请所有施工/挖掘/土地证照。' 
            },
            { 
                id: 'rega', 
                name: '房地产总局', 
                abbr: 'REGA', 
                type: 'authority', 
                role: '行业监管 / 裁判员', 
                desc: '负责房地产行业的立法、发牌与监管。2023年起强力执行《房地产经纪法》。', 
                details: '<strong>官网：</strong><a href="https://www.rega.gov.sa" target="_blank" class="text-saudi-green hover:underline">www.rega.gov.sa</a><br><br><strong>生态位：</strong>管人（中介）、管行为（交易）、管数据。行政独立但受MOMAH部长领导。<br><strong>核心辖区：</strong><br>1. <strong>Ejar</strong>：租赁强制备案，不备案不受法律保护。<br>2. <strong>Wafi</strong>：期房销售与资金监管（预售证）。<br>3. <strong>Mullak</strong>：分契式产权与业主协会(HOA)注册。' 
            },
            { 
                id: 'rcrc', 
                name: '利雅得皇家委员会', 
                abbr: 'RCRC', 
                type: 'ministry', 
                role: '战略顶层 / 超级大脑', 
                desc: '直属内阁，王储挂帅。在利雅得，其战略地位高于市政署。', 
                details: '<strong>官网：</strong><a href="https://www.rcrc.gov.sa" target="_blank" class="text-saudi-green hover:underline">www.rcrc.gov.sa</a><br><br><strong>生态位：</strong>利雅得真正的战略制定者，服务于“2030愿景”。<br><strong>职能：</strong>负责利雅得大都市圈总体规划（如Metro, Riyadh Green）。我们的项目规划必须符合其《利雅得2030战略》。' 
            },
            { 
                id: 'amanah', 
                name: '利雅得市政署', 
                abbr: 'Amanah', 
                type: 'execution', 
                role: '地方执行 / 地方诸侯', 
                desc: '垂直隶属于MOMAH，拥有极大的地方自由裁量权。', 
                details: '<strong>官网：</strong><a href="https://www.alriyadh.gov.sa" target="_blank" class="text-saudi-green hover:underline">www.alriyadh.gov.sa</a><br><br><strong>生态位：</strong>战略听RCRC，政策听MOMAH，具体落地Amanah说了算。<br><strong>职能：</strong><br>1. <strong>发证</strong>：盖章《建筑施工许可证》和《完工证》。<br>2. <strong>执法</strong>：负责现场检查、卫生合规、违建罚款。' 
            },
            { 
                id: 'nhc', 
                name: '国家住房公司', 
                abbr: 'NHC', 
                type: 'partner', 
                role: '国企地主 / 房产界阿美', 
                desc: 'MOMAH的投资臂膀，沙特最大的住宅用地持有者。', 
                details: '<strong>官网：</strong><a href="https://www.nhc.sa" target="_blank" class="text-saudi-green hover:underline">www.nhc.sa</a><br><br><strong>生态位：</strong>既是监管方（标准制定），又是最大合作伙伴。<br><strong>合作价值：</strong><br>1. <strong>拿地</strong>：掌握大量政府划拨土地，可作为Sub-developer合作开发。<br>2. <strong>销售</strong>：拥有Sakani数据库，直接对接政府补贴购房客群。' 
            },
             { 
                id: 'roshn', 
                name: 'ROSHN 罗申', 
                abbr: 'ROSHN', 
                type: 'partner', 
                role: '社区缔造者 / PIF全资', 
                desc: 'PIF旗下的大型房地产开发商，专注于建设高品质的综合社区。', 
                details: '<strong>官网：</strong><a href="https://www.roshn.sa" target="_blank" class="text-saudi-green hover:underline">www.roshn.sa</a><br><br><strong>生态位：</strong>沙特“2030愿景”的关键推动者之一，致力于将住房拥有率提高到70%。<br><strong>特点：</strong>不同于NHC的平台属性，ROSHN更像是一个超级开发商，直接下场拿地盖房，并在全国范围内开发大规模社区（如Sedra）。' 
            },
            { 
                id: 'misa', 
                name: '投资部', 
                abbr: 'MISA', 
                type: 'ministry', 
                role: '外资准入 / 招商局', 
                desc: '负责发放《投资许可证》(MISA License)，外资经营的“身份证”。', 
                details: '<strong>官网：</strong><a href="https://misa.gov.sa" target="_blank" class="text-saudi-green hover:underline">misa.gov.sa</a><br><br><strong>生态位：</strong>外资企业的保护伞和跨部门协调人。<br><strong>职能：</strong>核发投资许可，前身为SAGIA。遇到跨部门推诿时，MISA是最重要的求助对象。' 
            },
            { 
                id: 'mc', 
                name: '商务部', 
                abbr: 'MC', 
                type: 'ministry', 
                role: '商业注册 / 工商局', 
                desc: '负责公司商业登记(CR)与公司法执行。', 
                details: '<strong>官网：</strong><a href="https://mc.gov.sa" target="_blank" class="text-saudi-green hover:underline">mc.gov.sa</a><br><br><strong>职能：</strong>发放《商业登记证》(CR)，核定公司类型（如LLC）和经营范围。相当于中国的“工商局 + 市场监督管理局”。' 
            },
            { 
                id: 'etmam', 
                name: '开发商服务中心', 
                abbr: 'Etmam', 
                type: 'ministry', 
                role: '绿色通道', 
                desc: 'MOMAH下属的一站式审批中心，加速大项目流程。', 
                details: '<strong>官网：</strong><a href="https://etmam.com.sa" target="_blank" class="text-saudi-green hover:underline">etmam.com.sa</a><br><br><strong>核心价值：</strong>MOMAH用来倒逼其他部门提高效率的工具。不仅是窗口，更是跨部门协调器。' 
            },
            { 
                id: 'balady', 
                name: 'Balady 平台', 
                abbr: 'Balady', 
                type: 'platform', 
                role: '市政许可', 
                desc: 'MOMAH的数字化门户，在线申请施工证。', 
                details: '<strong>官网：</strong><a href="https://balady.gov.sa" target="_blank" class="text-saudi-green hover:underline">balady.gov.sa</a><br><br><strong>必用平台：</strong>所有与土地、建设、挖掘相关的许可证均在此平台全数字化申请。' 
            },
            { 
                id: 'ejar', 
                name: 'Ejar 租赁网', 
                abbr: 'Ejar', 
                type: 'platform', 
                role: '租赁备案', 
                desc: 'REGA下属平台，政府控制租房市场的抓手。', 
                details: '<strong>官网：</strong><a href="https://www.ejar.sa" target="_blank" class="text-saudi-green hover:underline">www.ejar.sa</a><br><br><strong>强制性：</strong>打通内政部系统。长租公寓合同必须备案，否则发生纠纷不受法律保护。' 
            },
            { 
                id: 'wafi', 
                name: 'Wafi 委员会', 
                abbr: 'Wafi', 
                type: 'platform', 
                role: '期房监管', 
                desc: 'REGA下属，相当于“预售办”。', 
                details: '<strong>官网：</strong><a href="https://wafi.housing.gov.sa" target="_blank" class="text-saudi-green hover:underline">wafi.housing.gov.sa</a><br><br><strong>核心职能：</strong>管理期房销售许可(Off-plan license)与Escrow资金监管账户，掌握开发商回款命脉。' 
            },
            { 
                id: 'mullak', 
                name: 'Mullak 计划', 
                abbr: 'Mullak', 
                type: 'platform', 
                role: '业主协会', 
                desc: 'REGA下属，管理分契式产权。', 
                details: '<strong>官网：</strong><a href="https://mullak.sa" target="_blank" class="text-saudi-green hover:underline">mullak.sa</a><br><br><strong>合规要求：</strong>运营整栋物业或进行分层销售时，必须在此注册业主委员会(HOA)以管理物业费。' 
            },
            { 
                id: 'tourism', 
                name: '旅游部', 
                abbr: 'Tourism', 
                type: 'ministry', 
                role: '酒店公寓监管', 
                desc: '负责旅游住宿设施的执照颁发与星级评定。', 
                details: '<strong>官网：</strong><a href="https://mt.gov.sa" target="_blank" class="text-saudi-green hover:underline">mt.gov.sa</a><br><br><strong>关键界限：</strong>若长租公寓提供日租/短租/前台服务，或被定性为“服务式公寓”，必须由旅游部发牌，而非住房部。' 
            },
            { 
                id: 'civil', 
                name: '民防总局', 
                abbr: 'Civil Defense', 
                type: 'execution', 
                role: '消防安全 / 一票否决', 
                desc: '隶属内政部，拥有完工验收的一票否决权。', 
                details: '<strong>官网：</strong><a href="https://998.gov.sa" target="_blank" class="text-saudi-green hover:underline">998.gov.sa</a><br><br><strong>严苛标准：</strong>任何公寓楼开业前，必须拿到民防局的消防许可证。' 
            },
            { 
                id: 'zatca', 
                name: '税务海关总局', 
                abbr: 'ZATCA', 
                type: 'authority', 
                role: '税务征收 / 财神爷', 
                desc: '负责管理增值税(VAT)、房地产交易税(RETT)。', 
                details: '<strong>官网：</strong><a href="https://zatca.gov.sa" target="_blank" class="text-saudi-green hover:underline">zatca.gov.sa</a><br><br><strong>核心税种：</strong><br>1. <strong>RETT</strong>：房产买卖需缴5%交易税。<br>2. <strong>VAT</strong>：商业租赁（如底商）需缴15%，住宅租赁通常免税。' 
            },
            { 
                id: 'redf', 
                name: '房地产发展基金', 
                abbr: 'REDF', 
                type: 'partner', 
                role: '金融支持 / 资金源', 
                desc: '国家发展基金序列，主要给公民发房贷补贴。', 
                details: '<strong>官网：</strong><a href="https://redf.gov.sa" target="_blank" class="text-saudi-green hover:underline">redf.gov.sa</a><br><br><strong>开发商机会：</strong>关注其 <strong>Tatweer</strong> 计划，这是专门为开发商提供的过桥融资渠道。' 
            }
        ];

        const lawsData = [
            { title: "房地产经纪法 (Real Estate Brokerage Law)", date: "2023生效", desc: "取缔自由经纪人，强制中介持证(Fal License)。规范佣金上限与独家代理合同。" },
            { title: "房地产参股/集资法 (Real Estate Contributions Law)", date: "2023生效", desc: "规范多方集资、众筹开发房地产的行为。由CMA(资本市场局)与REGA双重监管。" },
            { title: "民事交易法 (Civil Transactions Law)", date: "2023生效", desc: "沙特首部民法典。确立了合同神圣性，减少了法官基于伊斯兰教法的自由裁量权，极大增强商业确定性。" },
            { title: "外商投资法 (Foreign Investment Law)", date: "基础法律", desc: "确立了外资与内资平等待遇原则。规定了MISA发牌制度及外资负面清单。" },
            { title: "非沙特人房地产所有权与投资法", date: "现行/修订中", desc: "目前非沙特人在利雅得买房仍受限(需审批)。新法草案旨在进一步放开限制，但尚未正式落地。" },
            { title: "房地产交易税法 (RETT Executive Regulations)", date: "2020生效", desc: "规定房地产处置免征15%增值税，改为征收5%的房地产交易税(RETT)，降低交易成本。" },
            { title: "民防与消防安全条例", date: "强制标准", desc: "内政部颁布的严格建筑消防标准。是获取完工证的前置条件，拥有最高执法权。" }
        ];

        const workflowSteps = [
            { title: "1. 市场准入", desc: "获取经营身份", tasks: [{dept:"MISA", txt:"申请投资许可"}, {dept:"MC", txt:"商业登记 (CR)"}, {dept:"ZATCA", txt:"税务登记"}] },
            { title: "2. 拿地规划", desc: "锁定项目用地", tasks: [{dept:"NHC", txt:"洽谈土地合作"}, {dept:"RCRC", txt:"2030合规审查"}, {dept:"MOMAH", txt:"Zoning用途变更"}] },
            { title: "3. 建设审批", desc: "从图纸到动工", tasks: [{dept:"Etmam", txt:"综合审批通道"}, {dept:"Balady", txt:"申请施工许可证"}, {dept:"Wafi", txt:"期房销售许可"}] },
            { title: "4. 验收交付", desc: "合规转为资产", tasks: [{dept:"民防", txt:"消防验收 (核心)"}, {dept:"Amanah", txt:"完工证申请"}, {dept:"Mullak", txt:"业主协会注册"}] },
            { title: "5. 运营管理", desc: "长期收益", tasks: [{dept:"Ejar", txt:"租赁合同备案"}, {dept:"Tourism", txt:"服务公寓执照"}, {dept:"ZATCA", txt:"税务申报"}] }
        ];

        // --- RENDER FUNCTIONS ---

        function renderDirectory(filterType = 'all', searchVal = '') {
            const grid = document.getElementById('directory-grid');
            grid.innerHTML = '';
            
            const filtered = agencyData.filter(d => {
                const matchType = filterType === 'all' || d.type === filterType;
                const matchSearch = d.name.includes(searchVal) || d.abbr.toLowerCase().includes(searchVal.toLowerCase());
                return matchType && matchSearch;
            });

            if (filtered.length === 0) {
                grid.innerHTML = `<div class="col-span-3 text-center py-10 text-gray-400">未找到匹配的机构</div>`;
                return;
            }

            filtered.forEach(d => {
                let colorClass = 'border-l-4 border-sand-200';
                let tagClass = 'bg-sand-100 text-slate-600';
                
                if(d.type === 'ministry') { colorClass = 'border-l-4 border-saudi-green'; tagClass = 'bg-saudi-green text-white'; }
                if(d.type === 'authority') { colorClass = 'border-l-4 border-gold-accent'; tagClass = 'bg-gold-accent text-white'; }
                if(d.type === 'execution') { colorClass = 'border-l-4 border-slate-500'; tagClass = 'bg-slate-500 text-white'; }
                if(d.type === 'partner') { colorClass = 'border-l-4 border-saudi-green-light'; tagClass = 'bg-saudi-green-light text-white'; }
                if(d.type === 'platform') { colorClass = 'border-l-4 border-sand-200'; tagClass = 'bg-sand-200 text-slate-800'; }

                grid.innerHTML += `
                    <div class="bg-white p-5 rounded-lg shadow-sm border border-sand-100 hover:shadow-md transition-all ${colorClass} group flex flex-col h-full">
                        <div class="flex justify-between items-start mb-3">
                            <h3 class="font-bold text-xl text-slate-800">${d.abbr}</h3>
                            <span class="text-[10px] px-2 py-1 rounded ${tagClass} font-bold">${d.role}</span>
                        </div>
                        <h4 class="text-sm font-bold text-gray-700 mb-2">${d.name}</h4>
                        <p class="text-xs text-gray-500 mb-4 h-10 overflow-hidden leading-relaxed">${d.desc}</p>
                        
                        <div class="mt-auto">
                            <details class="text-xs text-gray-600 border-t border-sand-100 pt-2 cursor-pointer group/details">
                                <summary class="list-none font-bold text-saudi-green-light flex items-center gap-1 hover:underline select-none">
                                    <span>展开详细职能</span>
                                    <svg class="w-3 h-3 transition-transform group-open/details:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </summary>
                                <p class="mt-2 p-2 bg-sand-50 rounded text-gray-700 border border-sand-100 leading-relaxed">${d.details}</p>
                            </details>
                        </div>
                    </div>
                `;
            });
        }

        function renderWorkflow(activeIndex = 0) {
            const stepsDiv = document.getElementById('workflow-steps-container');
            const contentDiv = document.getElementById('workflow-content');
            
            stepsDiv.innerHTML = workflowSteps.map((s, i) => `
                <button onclick="renderWorkflow(${i})" class="w-full text-left px-5 py-4 rounded-xl border transition-all flex items-center justify-between group ${i===activeIndex ? 'bg-white border-gold-accent shadow-md ring-1 ring-gold-accent z-10 relative' : 'bg-white border-sand-200 hover:bg-sand-50 text-gray-500 hover:border-gold-accent/50'}">
                    <div>
                        <div class="font-bold text-sm ${i===activeIndex ? 'text-saudi-green' : 'group-hover:text-saudi-green transition-colors'}">${s.title}</div>
                        <div class="text-xs mt-1 ${i===activeIndex ? 'text-gold-accent' : 'text-gray-400'}">${s.desc}</div>
                    </div>
                    ${i===activeIndex ? '<svg class="w-5 h-5 text-gold-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>' : ''}
                </button>
            `).join('');

            const step = workflowSteps[activeIndex];
            contentDiv.innerHTML = `
                <div class="relative z-10 animate-fade-in">
                    <div class="text-xs font-bold text-gold-accent uppercase tracking-widest mb-2 flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-gold-accent animate-pulse"></span>
                        当前阶段
                    </div>
                    <h3 class="text-3xl font-bold text-saudi-green mb-1">${step.title}</h3>
                    <p class="text-gray-500 mb-8 font-medium">${step.desc}</p>
                    
                    <div class="space-y-4">
                        ${step.tasks.map((t, idx) => `
                            <div class="flex items-center p-4 bg-sand-50 rounded-lg border border-sand-200 hover:border-saudi-green/30 transition-colors" style="animation: fadeIn 0.3s ease-out both; animation-delay: ${idx * 0.1}s">
                                <span class="px-2 py-1 rounded bg-saudi-green text-white text-xs font-bold mr-4 min-w-[70px] text-center shadow-sm">${t.dept}</span>
                                <span class="text-sm text-gray-700 font-medium">${t.txt}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="absolute -bottom-16 -right-12 text-[200px] font-bold text-sand-100/50 select-none pointer-events-none">${activeIndex+1}</div>
            `;
        }

        function renderLaws() {
            const container = document.getElementById('legal-list');
            container.innerHTML = lawsData.map(law => `
                <div class="bg-white border border-sand-200 rounded-lg overflow-hidden hover:shadow-md transition-all group">
                    <details class="group">
                        <summary class="flex justify-between items-center p-5 cursor-pointer list-none bg-white hover:bg-sand-50 transition-colors">
                            <div class="flex-1">
                                <h4 class="font-bold text-slate-800 text-lg group-open:text-saudi-green transition-colors flex items-center gap-3">
                                    ${law.title}
                                    <span class="text-[10px] font-bold px-2 py-0.5 rounded bg-sand-100 text-saudi-green border border-saudi-green/10">${law.date}</span>
                                </h4>
                            </div>
                            <div class="bg-sand-100 rounded-full p-1 ml-4 group-open:bg-saudi-green group-open:text-white transition-colors">
                                <svg class="w-5 h-5 text-gray-500 group-open:text-white transform group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                        </summary>
                        <div class="p-6 border-t border-sand-100 bg-sand-50 text-sm text-gray-600 leading-relaxed">
                            <div class="flex gap-3">
                                <div class="w-1 bg-gold-accent rounded-full shrink-0"></div>
                                <div>
                                    <span class="font-bold text-saudi-green block mb-1">核心内容与影响：</span>
                                    ${law.desc}
                                </div>
                            </div>
                        </div>
                    </details>
                </div>
            `).join('');
        }

        function initFilters() {
            const container = document.getElementById('filter-container');
            const filters = [
                {id: 'all', txt: '全部'},
                {id: 'ministry', txt: '部委'},
                {id: 'authority', txt: '总局'},
                {id: 'execution', txt: '执行'},
                {id: 'platform', txt: '平台'},
                {id: 'partner', txt: '国企'}
            ];
            container.innerHTML = filters.map(f => `
                <button onclick="applyFilter('${f.id}')" class="filter-btn px-4 py-1.5 rounded-full text-xs font-bold border border-sand-200 hover:bg-sand-100 text-slate-500 transition-all hover:shadow-sm" data-id="${f.id}">
                    ${f.txt}
                </button>
            `).join('');
            // Set All active
            applyFilter('all');
        }

        function applyFilter(type) {
            document.querySelectorAll('.filter-btn').forEach(b => {
                b.className = 'filter-btn px-4 py-1.5 rounded-full text-xs font-bold border border-sand-200 hover:bg-sand-100 text-slate-500 transition-all hover:shadow-sm';
            });
            const activeBtn = document.querySelector(`[data-id="${type}"]`);
            if(activeBtn) {
                activeBtn.className = 'filter-btn px-4 py-1.5 rounded-full text-xs font-bold bg-saudi-green text-white border-transparent shadow-md transform scale-105';
            }
            
            renderDirectory(type, document.getElementById('searchInput').value);
        }

        // --- Navigation Logic ---
        function showSection(sectionId) {
            document.querySelectorAll('.section-content').forEach(el => {
                el.classList.add('hidden');
                el.classList.remove('block');
            });
            const target = document.getElementById(sectionId);
            target.classList.remove('hidden');
            target.classList.add('block');

            document.querySelectorAll('.nav-item').forEach(el => {
                if(el.dataset.target === sectionId) {
                    el.classList.add('bg-white/10', 'text-white', 'shadow-inner');
                    el.classList.remove('opacity-80');
                } else {
                    el.classList.remove('bg-white/10', 'text-white', 'shadow-inner');
                    el.classList.add('opacity-80');
                }
            });

            // Mobile menu close
            if(window.innerWidth < 1024) {
                 document.getElementById('sidebar').classList.add('-translate-x-full');
                 document.getElementById('sidebar-overlay').classList.add('hidden');
            }
        }

        // --- Gemini AI Logic (Adapted for Knowledge Base) ---
        const apiKey = ""; 
        
        const reportContext = `
            知识库内容摘要：
            1. 核心机构：
            - MOMAH (市政与住房部): 房地产最高主管部门，定政策。
            - REGA (房地产总局): 监管者，负责Fal(中介), Ejar(租赁), Wafi(期房)平台。
            - RCRC (利雅得皇家委员会): 战略顶层，负责2030愿景。
            - Amanah (市政署): 地方执行层，负责发证、执法。
            - NHC (国家住房公司): 国企地主，最大土地持有者。
            - MISA (投资部): 发外资牌照。
            
            2. 业务流程：
            - 市场准入: MISA许可 -> MC商业登记 -> ZATCA税务。
            - 拿地: NHC合作 -> RCRC审查 -> MOMAH变性。
            - 建设: Etmam审批 -> Balady施工证 -> Wafi销售证。
            - 交付: 民防消防验收 -> Amanah完工证 -> Mullak业委会。
            
            3. 法律法规：
            - 房地产经纪法: 强制持证。
            - 民事交易法: 合同神圣性。
            - 租金冻结: 利雅得新政，冻结5年。
        `;

        async function callGemini(userQuery) {
            // Simulation Mode for when API Key is missing in this static file
            if (!apiKey) {
                await new Promise(r => setTimeout(r, 1500)); // Simulate network delay
                
                // Simple keyword matching for demo purposes
                if (userQuery.includes("REGA") || userQuery.includes("MOMAH")) {
                    return "<strong>MOMAH (市政与住房部)</strong> 是制定政策的最高部门，相当于我们的“娘家”。\n\n而 <strong>REGA (房地产总局)</strong> 是监管机构，负责具体的行业监管，比如给中介发牌、管理租赁平台。简单来说，MOMAH是定规矩的，REGA是盯着大家守规矩的。";
                } else if (userQuery.includes("流程") || userQuery.includes("拿地")) {
                    return "拿地开发的核心流程如下：\n1. **市场准入**：先搞定MISA投资许可。\n2. **拿地**：找NHC合作拿地，或者购买私地，需要过RCRC的战略审查。\n3. **建设**：通过Etmam走绿色通道，在Balady上拿施工证。\n4. **销售**：如果是期房，必须拿到Wafi许可。";
                } else if (userQuery.includes("外资") || userQuery.includes("MISA")) {
                    return "外国投资者进入沙特的第一步必须是获得 <strong>MISA (投资部)</strong> 的许可证。这是我们在沙特合法经营的“身份证”。获得许可后，才能去商务部(MC)注册公司，去税务局(ZATCA)登记税务。";
                } else {
                    return "这是一个关于Smart Oasis内部知识库的好问题。根据我们的资料，沙特房地产市场呈现扁平化管理特征。如果您需要关于具体机构（如NHC, Amanah）的细节，请具体询问。";
                }
            }

            const systemPrompt = `
                你是一位沙特房地产市场专家，也是Smart Oasis公司的内部知识助手。
                基于以下知识库内容回答用户问题。
                保持回答专业、简洁、有条理。
                
                知识库内容：
                ${reportContext}
            `;

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error('API Error');

                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Gemini Error:", error);
                return "抱歉，我现在无法连接到知识库服务器。";
            }
        }

        // --- Chat UI Logic ---
        function toggleAIChat() {
            const panel = document.getElementById('ai-chat-panel');
            const overlay = document.getElementById('chat-overlay');
            
            if (panel.classList.contains('translate-x-full')) {
                panel.classList.remove('translate-x-full');
                overlay.classList.remove('hidden');
                setTimeout(() => overlay.classList.remove('opacity-0'), 10);
                document.getElementById('user-input').focus();
            } else {
                panel.classList.add('translate-x-full');
                overlay.classList.add('opacity-0');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            }
        }

        function appendMessage(text, sender) {
            const chatBox = document.getElementById('chat-messages');
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${sender} animate-fade-in`;
            
            if (sender === 'ai') {
                let formattedText = text.replace(/\n/g, '<br>');
                formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<strong class="text-saudi-green">$1</strong>');
                bubble.innerHTML = formattedText;
            } else {
                bubble.textContent = text;
            }
            
            chatBox.appendChild(bubble);
            chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
        }

        function appendLoading() {
            const chatBox = document.getElementById('chat-messages');
            const bubble = document.createElement('div');
            bubble.id = 'loading-bubble';
            bubble.className = 'chat-bubble ai';
            bubble.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
            chatBox.appendChild(bubble);
            chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
        }

        function removeLoading() {
            const bubble = document.getElementById('loading-bubble');
            if (bubble) bubble.remove();
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if (!text) return;

            appendMessage(text, 'user');
            input.value = '';
            appendLoading();

            const response = await callGemini(text);

            removeLoading();
            appendMessage(response, 'ai');
        }
        
        function askQuestion(question) {
            const input = document.getElementById('user-input');
            input.value = question;
            sendMessage();
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter') sendMessage();
        }

        document.getElementById('menu-btn').addEventListener('click', () => {
            document.getElementById('sidebar').classList.remove('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.remove('hidden');
        });

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            renderWorkflow();
            initFilters();
            renderDirectory();
            renderLaws();
            
            document.getElementById('searchInput').addEventListener('input', (e) => renderDirectory('all', e.target.value));
            
            // Set initial active tab
            showSection('dashboard');
        });

    </script>
</body>
</html>
